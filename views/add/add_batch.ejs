<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <title>New Batch</title>
    <link rel="stylesheet" href="/stylesheets/add_batch.css" />
  </head>

  <body>
    <%- include("../partials/qualityNav") %>

    <div class="details">
      <div class="main">
        <h1>Corporate</h1>
        <h3>Enter Batch Details</h3>

        <form action="/batch/new" method="post">
          <label for="date"> Date: </label>
          <input
            type="text"
            id="date"
            name="date"
            value="<%= new Date().toLocaleDateString('en-GB') %>"
            required
          />

          <label for="shift">Shift: </label>
          <input
            type="text"
            list="shiftOptions"
            id="shift"
            name="shift"
            class="uppercase"
            required
          />
          <datalist id="shiftOptions">
            <option value="A"></option>
            <option value="B"></option>
            <option value="C"></option>
          </datalist>

          <label for="design"> Design: </label>
          <input
            type="text"
            list="designList"
            id="design"
            name="design"
            class="uppercase"
            required
          />
          <datalist id="designList"></datalist>

          <label for="debossed">Logo: </label>
          <input
            type="text"
            id="debossed"
            list="logoList"
            name="debossed"
            class="uppercase"
            required
          />
          <datalist id="logoList"></datalist>

          <label for="mc_no"> Machine No.: </label>
          <input
            type="text"
            id="mc_no"
            list="machineList"
            name="mc_no"
            class="uppercase"
            required
          />
          <datalist id="machineList">
            <option value="CCM-01"></option>
            <option value="CCM-02"></option>
            <option value="CCM-03"></option>
            <option value="CCM-04"></option>
            <option value="CCM-05"></option>
            <option value="CCM-06"></option>
            <option value="CCM-07 / CCM-08"></option>
            <option value="CCM-09 / CCM-10 / CCM-11"></option>
            <option value="CCM-12"></option>
            <option value="CCM-14"></option>
            <option value="CCM-15"></option>
            <option value="CCM-16"></option>
            <option value="CCM-17"></option>
          </datalist>

          <label for="rm">Raw Material: </label>
          <input
            type="text"
            id="rm"
            name="rm"
            class="uppercase"
            list="rmList"
            required
          />
          <datalist id="rmList"></datalist>

          <label for="mb_code">Master Batch Code: </label>
          <input
            list="mb_codes"
            id="mb_code"
            name="mb_code"
            class="uppercase"
            required
          />
          <datalist id="mb_codes"></datalist>

          <label for="mc_speed">Machine Speed: </label>
          <input type="text" id="mc_speed" name="mc_speed" required />

          <label for="issued_by">Issued By: </label>
          <input
            type="text"
            id="issued_by"
            name="issued_by"
            class="uppercase"
            value="<%= user ? user: '' %>"
            readonly
            required
          />

          <div class="wrap">
            <button type="submit">Submit</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      async function loadDatalist(apiUrl, datalistId) {
        try {
          const res = await fetch(apiUrl);
          const codes = await res.json();

          const datalist = document.getElementById(datalistId);
          datalist.innerHTML = "";

          codes.forEach((code) => {
            const option = document.createElement("option");
            option.value = code;
            datalist.appendChild(option);
          });
        } catch (err) {
          console.error(`Error loading ${datalistId}:`, err);
        }
      }

      // Load all datalists
      window.addEventListener("DOMContentLoaded", () => {
        loadDatalist("/api/design", "designList");
        loadDatalist("/api/logo", "logoList");
        loadDatalist("/api/rm", "rmList");
        loadDatalist("/api/mbcodes", "mb_codes");
      });

      // Force uppercase globally
      document.addEventListener("input", (e) => {
        if (e.target.classList.contains("uppercase")) {
          e.target.value = e.target.value.toUpperCase();
        }
      });

      // Force uppercase for all inputs with class="uppercase"
      document.querySelectorAll("input.uppercase").forEach((input) => {
        input.addEventListener("input", function () {
          this.value = this.value.toUpperCase();
        });
      });

       const input = document.getElementById("mc_no");
  const options = Array.from(document.querySelectorAll("#machineList option")).map(opt => opt.value);

  input.addEventListener("input", function () {
    if (!options.includes(this.value)) {
      this.setCustomValidity("Please select a valid option from the list.");
    } else {
      this.setCustomValidity(""); // clears error if valid
    }
  });

  input.addEventListener("blur", function () {
    if (!options.includes(this.value)) {
      this.value = ""; // clear invalid input on blur
    }
  });
    </script>
  </body>
</html>
